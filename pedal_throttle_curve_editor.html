<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedal & Throttle Power Assist Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .title {
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 5px;
        }
        
        .tab-button {
            flex: 1;
            padding: 15px 30px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 18px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .tab-button.active {
            background: linear-gradient(45deg, #00c9ff, #92fe9d);
            color: #333;
            transform: scale(1.05);
        }
        
        .tab-button:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            position: relative;
        }
        
        .chart-container {
            position: relative;
            height: 500px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 15px;
        }
        
        .controls-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
        }
        
        .level-group {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .level-group.level1 { border-left-color: #007bff; }
        .level-group.level2 { border-left-color: #ffc107; }
        .level-group.level3 { border-left-color: #dc3545; }
        
        .level-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .level-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .level1 .level-indicator { background: #007bff; }
        .level2 .level-indicator { background: #ffc107; }
        .level3 .level-indicator { background: #dc3545; }
        
        .point-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .point-control {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .point-control label {
            font-size: 12px;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        
        .point-control input {
            width: 60px;
            padding: 5px;
            border: none;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-align: center;
            font-weight: bold;
        }
        
        .calculated-params {
            background: rgba(0, 255, 150, 0.1);
            border: 1px solid rgba(0, 255, 150, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .calculated-params h3 {
            color: #00ff96;
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .param-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-family: 'Courier New', monospace;
        }
        
        .preset-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .preset-btn {
            background: linear-gradient(45deg, #00c9ff, #92fe9d);
            color: #333;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
        }
        
        .preset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 201, 255, 0.4);
        }
        
        .preset-btn.active {
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            transform: scale(1.05);
        }
        
        .apply-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
            border: none;
            border-radius: 10px;
            color: #333;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }
        
        .apply-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(86, 171, 47, 0.4);
        }
        
        .drag-hint {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }
        
        .mode-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">üö¥‚Äç‚ôÇÔ∏è Pedal & Throttle Power Assist Editor</h1>
        
        <div class="tab-container">
            <button class="tab-button active" onclick="switchTab('pedal')">
                ü¶µ Pedal Assist
                <small style="font-size: 12px;">(Pedal Power ‚Üí Motor Output)</small>
            </button>
            <button class="tab-button" onclick="switchTab('throttle')">
                üéõÔ∏è Throttle Progressive
                <small style="font-size: 12px;">(Raw ‚Üí Processed Position)</small>
            </button>
        </div>
        
        <!-- Pedal Assist È†ÅÁ±§ -->
        <div id="pedal-tab" class="tab-content active">
            <div class="mode-info">
                <strong>Pedal Assist Mode:</strong> Pedal input power (W) corresponds to motor output power (W)
            </div>
            
            <div class="main-content">
                <div class="chart-section">
                    <div class="drag-hint">Drag points to adjust curves</div>
                    <div class="chart-container">
                        <canvas id="pedalChart"></canvas>
                    </div>
                </div>
                
                <div class="controls-section">
                    <div class="calculated-params">
                        <h3>üìä Calculated Segment Slopes</h3>
                        <div id="pedal-calculated-slopes"></div>
                    </div>
                    
                    <div class="calculated-params">
                        <h3>‚öôÔ∏è Bike Parameters</h3>
                        <div id="pedal-bike-params"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Throttle Progressive È†ÅÁ±§ -->
        <div id="throttle-tab" class="tab-content">
            <div class="mode-info">
                <strong>Throttle Progressive Mode:</strong> Raw throttle position (%) corresponds to processed throttle position (%)
            </div>
            
            <div class="main-content">
                <div class="chart-section">
                    <div class="drag-hint">Drag points to adjust curves</div>
                    <div class="chart-container">
                        <canvas id="throttleChart"></canvas>
                    </div>
                </div>
                
                <div class="controls-section">
                    <div class="level-group level1">
                        <div class="level-title">
                            <div class="level-indicator"></div>
                            Level 1 Multiplier
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="range" id="level1-multiplier" min="0" max="100" value="50" 
                                   style="flex: 1;" onchange="updateMultiplier('level1', this.value)">
                            <span id="level1-value" style="min-width: 40px; font-weight: bold;">50%</span>
                        </div>
                    </div>
                    
                    <div class="level-group level2">
                        <div class="level-title">
                            <div class="level-indicator"></div>
                            Level 2 Multiplier
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="range" id="level2-multiplier" min="0" max="100" value="75" 
                                   style="flex: 1;" onchange="updateMultiplier('level2', this.value)">
                            <span id="level2-value" style="min-width: 40px; font-weight: bold;">75%</span>
                        </div>
                    </div>
                    
                    <div class="level-group level3">
                        <div class="level-title">
                            <div class="level-indicator"></div>
                            Level 3 Multiplier
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="range" id="level3-multiplier" min="0" max="100" value="100" 
                                   style="flex: 1;" onchange="updateMultiplier('level3', this.value)">
                            <span id="level3-value" style="min-width: 40px; font-weight: bold;">100%</span>
                        </div>
                    </div>
                    
                    <div class="calculated-params">
                        <h3>üìä Calculated Segment Slopes</h3>
                        <div id="throttle-calculated-slopes"></div>
                    </div>
                    
                    <div class="calculated-params">
                        <h3>‚öôÔ∏è Bike Parameters</h3>
                        <div id="throttle-bike-params"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let pedalChart, throttleChart;
        let isDragging = false;
        let dragInfo = null;
        let currentTab = 'pedal';
        
        // PedalÊï∏Êìö - ËÖ≥Ë∏©ÂäüÁéá(W) Â∞çÊáâ È¶¨ÈÅîËº∏Âá∫ÂäüÁéá(W) - ÊîπÊàê3ÂÄãÈªû
        let pedalCurves = {
            level1: [
                {x: 100, y: 50},   // 100WË∏©Ë∏è -> 50WËº∏Âá∫
                {x: 200, y: 120},  // 200WË∏©Ë∏è -> 120WËº∏Âá∫
                {x: 300, y: 200}   // 300WË∏©Ë∏è -> 200WËº∏Âá∫
            ],
            level2: [
                {x: 100, y: 80},   // 100WË∏©Ë∏è -> 80WËº∏Âá∫
                {x: 200, y: 200},  // 200WË∏©Ë∏è -> 200WËº∏Âá∫
                {x: 300, y: 350}   // 300WË∏©Ë∏è -> 350WËº∏Âá∫
            ],
            level3: [
                {x: 100, y: 120},  // 100WË∏©Ë∏è -> 120WËº∏Âá∫
                {x: 200, y: 300},  // 200WË∏©Ë∏è -> 300WËº∏Âá∫
                {x: 300, y: 500}   // 300WË∏©Ë∏è -> 500WËº∏Âá∫
            ]
        };
        
        // ThrottleÊï∏Êìö - ÁØÄÊµÅ‰ΩçÁΩÆ(%) Â∞çÊáâ ÈõªÊµÅÁôæÂàÜÊØî(%) - Á¨¨‰∏ÄÂÄãsegmentÊñúÁéáÂõ∫ÂÆöÁÇ∫0ÔºåÊúÄÂæå‰∏ÄÈªûYÂÄºÂõ∫ÂÆöÁÇ∫100
        let throttleCurves = {
            level1: [
                {x: 25, y: 0},   // Á¨¨‰∏ÄÂÄãÈªûÂõ∫ÂÆöy=0
                {x: 50, y: 40},
                {x: 70, y: 80},
                {x: 80, y: 100}  // ÊúÄÂæå‰∏ÄÈªûÂõ∫ÂÆöy=100
            ],
            level2: [
                {x: 25, y: 0},   // Á¨¨‰∏ÄÂÄãÈªûÂõ∫ÂÆöy=0
                {x: 50, y: 30},
                {x: 70, y: 60},
                {x: 80, y: 100}  // ÊúÄÂæå‰∏ÄÈªûÂõ∫ÂÆöy=100
            ],
            level3: [
                {x: 25, y: 0},   // Á¨¨‰∏ÄÂÄãÈªûÂõ∫ÂÆöy=0
                {x: 50, y: 13},
                {x: 70, y: 42},
                {x: 80, y: 100}  // ÊúÄÂæå‰∏ÄÈªûÂõ∫ÂÆöy=100
            ]
        };
        
        // È†ÅÁ±§ÂàáÊèõ
        function switchTab(tabName) {
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Êõ¥Êñ∞ÂÖßÂÆπÈ°ØÁ§∫
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            currentTab = tabName;
            
            // Êõ¥Êñ∞Â∞çÊáâÁöÑÂúñË°®
            if (tabName === 'pedal') {
                setTimeout(() => updatePedalChart(), 100);
            } else {
                setTimeout(() => updateThrottleChart(), 100);
            }
        }
        
        // Ë®àÁÆóÂàÜÊÆµÊñúÁéá - ÊîπÁÇ∫Êï¥Êï∏È°ØÁ§∫
        function calculateSlopes(points) {
            const slopes = [];
            let prevX = 0, prevY = 0;
            
            for (let i = 0; i < points.length; i++) {
                const currentX = points[i].x;
                const currentY = points[i].y;
                
                if (currentX > prevX) {
                    const slope = ((currentY - prevY) / (currentX - prevX)) * 100;
                    slopes.push({
                        segment: i + 1,
                        range: `${Math.round(prevX)} - ${Math.round(currentX)}`,
                        slope: Math.round(slope) // ÊîπÁÇ∫Êï¥Êï∏
                    });
                }
                
                prevX = currentX;
                prevY = currentY;
            }
            
            return slopes;
        }
        
        // ÁîüÊàêÁõ¥Á∑öÈÄ£Êé•Êï∏ÊìöÔºåÊúÄÂæå‰∏ÄÈªûÂª∂‰º∏Ê∞¥Âπ≥Á∑öÔºåÊáâÁî®‰πòÊï∏
        function generateLinearCurve(points, level = null) {
            const linearData = [];
            
            // ÂæûÂéüÈªûÈñãÂßã
            linearData.push({x: 0, y: 0});
            
            // Ê∑ªÂä†ÊéßÂà∂ÈªûÔºåÁõ¥Á∑öÈÄ£Êé•
            points.forEach(point => {
                let yValue = point.y;
                
                // Â¶ÇÊûúÊòØThrottleÊ®°Âºè‰∏îÊúâÊåáÂÆölevelÔºåÊáâÁî®‰πòÊï∏
                if (currentTab === 'throttle' && level && window.throttleLevelMultipliers) {
                    yValue = point.y * window.throttleLevelMultipliers[level] / 100;
                }
                
                linearData.push({x: point.x, y: yValue});
            });
            
            // Âú®ÊúÄÂæå‰∏ÄÈªûÂä†ÂÖ•ÂæÄÂè≥Âª∂‰º∏ÁöÑÊ∞¥Âπ≥Á∑ö
            if (points.length > 0) {
                const lastPoint = points[points.length - 1];
                const maxX = currentTab === 'pedal' ? 400 : 100;
                if (lastPoint.x < maxX) {
                    let lastY = lastPoint.y;
                    
                    // ÊáâÁî®‰πòÊï∏Âà∞Âª∂‰º∏Á∑ö
                    if (currentTab === 'throttle' && level && window.throttleLevelMultipliers) {
                        lastY = lastPoint.y * window.throttleLevelMultipliers[level] / 100;
                    }
                    
                    linearData.push({x: maxX, y: lastY});
                }
            }
            
            return linearData;
        }
        
        // Êõ¥Êñ∞‰πòÊï∏
        function updateMultiplier(level, value) {
            if (!window.throttleLevelMultipliers) {
                window.throttleLevelMultipliers = {level1: 50, level2: 75, level3: 100};
            }
            window.throttleLevelMultipliers[level] = parseInt(value);
            document.getElementById(`${level}-value`).textContent = value + '%';
            
            // Êõ¥Êñ∞ÂúñË°®
            if (currentTab === 'throttle') {
                updateThrottleChart();
            }
        }
        
        // Êõ¥Êñ∞PedalÂúñË°®
        function updatePedalChart() {
            if (!pedalChart) return;
            
            const datasets = [
                {
                    label: 'Level 1',
                    data: generateLinearCurve(pedalCurves.level1),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0, // Ë®≠ÁÇ∫0‰ΩøÁî®Áõ¥Á∑öÈÄ£Êé•
                    pointRadius: 0,
                    pointHoverRadius: 0
                },
                {
                    label: 'Level 2',
                    data: generateLinearCurve(pedalCurves.level2),
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0,
                    pointRadius: 0,
                    pointHoverRadius: 0
                },
                {
                    label: 'Level 3',
                    data: generateLinearCurve(pedalCurves.level3),
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0,
                    pointRadius: 0,
                    pointHoverRadius: 0
                }
            ];
            
            // Ê∑ªÂä†ÂèØÊãñÊãΩÁöÑÊéßÂà∂Èªû
            Object.keys(pedalCurves).forEach((level, levelIndex) => {
                const colors = ['#007bff', '#ffc107', '#dc3545'];
                pedalCurves[level].forEach((point, pointIndex) => {
                    datasets.push({
                        label: `pedal_${level}_point_${pointIndex}`,
                        data: [point],
                        borderColor: colors[levelIndex],
                        backgroundColor: colors[levelIndex],
                        borderWidth: 2,
                        pointRadius: 8,
                        pointHoverRadius: 12,
                        showLine: false,
                        pointStyle: 'circle'
                    });
                });
            });
            
            pedalChart.data.datasets = datasets;
            pedalChart.update('none');
            
            updatePedalCalculatedParams();
        }
        
        // Êõ¥Êñ∞ThrottleÂúñË°®
        function updateThrottleChart() {
            if (!throttleChart) return;
            
            const datasets = [
                {
                    label: 'Level 1',
                    data: generateLinearCurve(throttleCurves.level1, 'level1'),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0, // Áõ¥Á∑öÈÄ£Êé•
                    pointRadius: 0,
                    pointHoverRadius: 0
                },
                {
                    label: 'Level 2',
                    data: generateLinearCurve(throttleCurves.level2, 'level2'),
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0,
                    pointRadius: 0,
                    pointHoverRadius: 0
                },
                {
                    label: 'Level 3',
                    data: generateLinearCurve(throttleCurves.level3, 'level3'),
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0,
                    pointRadius: 0,
                    pointHoverRadius: 0
                }
            ];
            
            // Ê∑ªÂä†ÂèØÊãñÊãΩÁöÑÊéßÂà∂ÈªûÔºàÈ°ØÁ§∫ÂéüÂßã‰ΩçÁΩÆÔºâ
            Object.keys(throttleCurves).forEach((level, levelIndex) => {
                const colors = ['#007bff', '#ffc107', '#dc3545'];
                throttleCurves[level].forEach((point, pointIndex) => {
                    // ÊéßÂà∂ÈªûÈ°ØÁ§∫ÊáâÁî®‰πòÊï∏ÂæåÁöÑ‰ΩçÁΩÆ
                    const multiplier = window.throttleLevelMultipliers ? window.throttleLevelMultipliers[level] : 100;
                    const adjustedY = point.y * multiplier / 100;
                    datasets.push({
                        label: `throttle_${level}_point_${pointIndex}`,
                        data: [{x: point.x, y: adjustedY}],
                        borderColor: colors[levelIndex],
                        backgroundColor: colors[levelIndex],
                        borderWidth: 2,
                        pointRadius: 8,
                        pointHoverRadius: 12,
                        showLine: false,
                        pointStyle: 'circle'
                    });
                });
            });
            
            throttleChart.data.datasets = datasets;
            throttleChart.update('none');
            
            updateThrottleCalculatedParams();
        }
        
        // Êõ¥Êñ∞PedalËº∏ÂÖ•Ê°ÜÊï∏ÂÄº - ÁßªÈô§Ê≠§ÂáΩÊï∏ÔºåÂõ†ÁÇ∫‰∏çÂÜçÈúÄË¶Å
        // function updatePedalInputValues() { ... }
        
        // Êõ¥Êñ∞ThrottleËº∏ÂÖ•Ê°ÜÊï∏ÂÄº - ÁßªÈô§Ê≠§ÂáΩÊï∏ÔºåÂõ†ÁÇ∫‰∏çÂÜçÈúÄË¶Å
        // function updateThrottleInputValues() { ... }
        
        // Êõ¥Êñ∞PedalË®àÁÆóÂèÉÊï∏
        function updatePedalCalculatedParams() {
            const container = document.getElementById('pedal-calculated-slopes');
            container.innerHTML = '';
            
            Object.keys(pedalCurves).forEach(level => {
                const slopes = calculateSlopes(pedalCurves[level]);
                const levelDiv = document.createElement('div');
                const levelColors = {level1: '#007bff', level2: '#ffc107', level3: '#dc3545'};
                
                levelDiv.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 8px; color: ${levelColors[level]}">
                        ${level.toUpperCase()}:
                    </div>
                `;
                
                slopes.forEach(slope => {
                    levelDiv.innerHTML += `
                        <div class="param-row">
                            <span>Segment ${slope.segment}: ${slope.range}W</span>
                            <span>Slope: ${slope.slope}%</span>
                        </div>
                    `;
                });
                
                levelDiv.innerHTML += '<br>';
                container.appendChild(levelDiv);
            });
            
            updatePedalBikeParams();
        }
        
        // Êõ¥Êñ∞Pedal BikeÂèÉÊï∏
        function updatePedalBikeParams() {
            const container = document.getElementById('pedal-bike-params');
            container.innerHTML = '';
            
            Object.keys(pedalCurves).forEach(level => {
                const slopes = calculateSlopes(pedalCurves[level]);
                const curve = pedalCurves[level];
                const levelColors = {level1: '#007bff', level2: '#ffc107', level3: '#dc3545'};
                const levelNum = level.replace('level', '');
                
                const levelDiv = document.createElement('div');
                levelDiv.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 8px; color: ${levelColors[level]}">
                        Level ${levelNum} Parameters:
                    </div>
                `;
                
                // Ëº∏Âá∫ÂêÑÂÄãÂèÉÊï∏ - Assist RatioÂñÆ‰Ωç0.1ÔºåÊñúÁéáÈô§‰ª•10
                slopes.forEach((slope, index) => {
                    const assistRatioName = ['First', 'Second', 'Third'][index];
                    if (assistRatioName) {
                        const assistRatioValue = Math.round(slope.slope / 10); // ÊñúÁéáÈô§‰ª•10ÔºåÂõõÊç®‰∫îÂÖ•Âà∞Êï¥Êï∏
                        levelDiv.innerHTML += `
                            <div class="param-row">
                                <span>Level ${levelNum} ${assistRatioName} Assist Ratio</span>
                                <span>${assistRatioValue}</span>
                            </div>
                        `;
                    }
                });
                
                // Power Points (Âè™È°ØÁ§∫ÂâçÂÖ©ÂÄãÊéßÂà∂Èªû) - ÂñÆ‰Ωç10WÔºåÈô§‰ª•10
                curve.forEach((point, index) => {
                    if (index < 2) { // Âè™È°ØÁ§∫FirstÂíåSecond Power Point
                        const powerPointName = ['First', 'Second'][index];
                        const powerPointValue = Math.round(point.x / 10); // ÂäüÁéáÈô§‰ª•10
                        levelDiv.innerHTML += `
                            <div class="param-row">
                                <span>Level ${levelNum} ${powerPointName} Power Point</span>
                                <span>${powerPointValue}</span>
                            </div>
                        `;
                    }
                });
                
                // Power Limit (ÊúÄÂæå‰∏ÄÈªûÁöÑYÂÄº) - ÂñÆ‰Ωç10WÔºåÈô§‰ª•10
                const lastPoint = curve[curve.length - 1];
                const powerLimitValue = Math.round(lastPoint.y / 10); // ÂäüÁéáÈô§‰ª•10
                levelDiv.innerHTML += `
                    <div class="param-row">
                        <span>Level ${levelNum} Power Limit</span>
                        <span>${powerLimitValue}</span>
                    </div>
                `;
                
                levelDiv.innerHTML += '<br>';
                container.appendChild(levelDiv);
            });
        }
        
        // Êõ¥Êñ∞ThrottleË®àÁÆóÂèÉÊï∏ÔºàËÄÉÊÖÆ‰πòÊï∏Ôºâ
        function updateThrottleCalculatedParams() {
            const container = document.getElementById('throttle-calculated-slopes');
            container.innerHTML = '';
            
            Object.keys(throttleCurves).forEach(level => {
                // ÂâµÂª∫Ë™øÊï¥ÂæåÁöÑÈªûÔºàÊáâÁî®‰πòÊï∏Ôºâ
                const multiplier = window.throttleLevelMultipliers ? window.throttleLevelMultipliers[level] : 100;
                const adjustedPoints = throttleCurves[level].map(point => ({
                    x: point.x,
                    y: point.y * multiplier / 100
                }));
                
                const slopes = calculateSlopes(adjustedPoints);
                const levelDiv = document.createElement('div');
                const levelColors = {level1: '#007bff', level2: '#ffc107', level3: '#dc3545'};
                
                levelDiv.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 8px; color: ${levelColors[level]}">
                        ${level.toUpperCase()} (√ó${multiplier}%):
                    </div>
                `;
                
                slopes.forEach(slope => {
                    levelDiv.innerHTML += `
                        <div class="param-row">
                            <span>Segment ${slope.segment}: ${slope.range}%</span>
                            <span>Slope: ${slope.slope}%</span>
                        </div>
                    `;
                });
                
                levelDiv.innerHTML += '<br>';
                container.appendChild(levelDiv);
            });
            
            updateThrottleBikeParams();
        }
        
        // Êõ¥Êñ∞Throttle BikeÂèÉÊï∏
        function updateThrottleBikeParams() {
            const container = document.getElementById('throttle-bike-params');
            container.innerHTML = '';
            
            Object.keys(throttleCurves).forEach(level => {
                const multiplier = window.throttleLevelMultipliers ? window.throttleLevelMultipliers[level] : 100;
                const adjustedPoints = throttleCurves[level].map(point => ({
                    x: point.x,
                    y: point.y * multiplier / 100
                }));
                
                const slopes = calculateSlopes(adjustedPoints);
                const curve = throttleCurves[level];
                const levelColors = {level1: '#007bff', level2: '#ffc107', level3: '#dc3545'};
                const levelNum = level.replace('level', '');
                
                const levelDiv = document.createElement('div');
                levelDiv.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 8px; color: ${levelColors[level]}">
                        Level ${levelNum} Parameters:
                    </div>
                `;
                
                // Throttle Current Slopes (Ë∑≥ÈÅéÁ¨¨‰∏ÄÂÄãÔºåÂõ†ÁÇ∫Âõ∫ÂÆöÁÇ∫0) - ÂñÆ‰Ωç0.1ÔºåÊñúÁéáÈô§‰ª•10
                slopes.forEach((slope, index) => {
                    if (index > 0) { // Ë∑≥ÈÅéÁ¨¨‰∏ÄÂÄãÊñúÁéáÔºàÂõ∫ÂÆöÁÇ∫0Ôºâ
                        const slopeName = ['First', 'Second', 'Third'][index - 1]; // ÈáçÊñ∞Á∑®Ëôü
                        const slopeValue = Math.round(slope.slope / 10); // ÊñúÁéáÈô§‰ª•10ÔºåÂõõÊç®‰∫îÂÖ•Âà∞Êï¥Êï∏
                        levelDiv.innerHTML += `
                            <div class="param-row">
                                <span>Level ${levelNum} ${slopeName} Throttle Current Slope</span>
                                <span>${slopeValue}</span>
                            </div>
                        `;
                    }
                });
                
                // Throttle Positions (ÊéßÂà∂ÈªûÁöÑXÂÄº)
                curve.forEach((point, index) => {
                    const positionName = ['First', 'Second', 'Third', 'Fourth'][index];
                    if (positionName) {
                        levelDiv.innerHTML += `
                            <div class="param-row">
                                <span>Level ${levelNum} ${positionName} Throttle Position</span>
                                <span>${Math.round(point.x)}%</span>
                            </div>
                        `;
                    }
                });
                
                // Throttle Position Limitation (‰πòÊï∏ÂÄº)
                levelDiv.innerHTML += `
                    <div class="param-row">
                        <span>Level ${levelNum} Throttle Position Limitation</span>
                        <span>${multiplier}%</span>
                    </div>
                `;
                
                levelDiv.innerHTML += '<br>';
                container.appendChild(levelDiv);
            });
        }
        
        // ËºâÂÖ•PedalÈ†êË®≠ - ÁßªÈô§Ê≠§ÂáΩÊï∏
        // function loadPedalPreset(level) { ... }
        
        // ËºâÂÖ•ThrottleÈ†êË®≠ - ÁßªÈô§Ê≠§ÂáΩÊï∏  
        // function loadThrottlePreset(level) { ... }
        
        // Ë®≠ÁΩÆÊãñÊãΩËôïÁêÜÂô®
        function setupDragHandlers(chart, curves, isThrottle = false) {
            chart.canvas.addEventListener('mousedown', (e) => {
                const points = Chart.helpers.getRelativePosition(e, chart);
                const dataX = chart.scales.x.getValueForPixel(points.x);
                const dataY = chart.scales.y.getValueForPixel(points.y);
                
                // Ê™¢Êü•ÊòØÂê¶ÈªûÊìäÂà∞ÊéßÂà∂Èªû
                Object.keys(curves).forEach(level => {
                    curves[level].forEach((point, index) => {
                        let checkX = point.x;
                        let checkY = point.y;
                        
                        // Â¶ÇÊûúÊòØThrottleÔºåÈúÄË¶ÅËÄÉÊÖÆ‰πòÊï∏Â∞çYÂÄºÁöÑÂΩ±Èüø‰æÜÊ™¢Ê∏¨
                        if (isThrottle && window.throttleLevelMultipliers) {
                            checkY = point.y * window.throttleLevelMultipliers[level] / 100;
                        }
                        
                        const distance = Math.sqrt(
                            Math.pow(dataX - checkX, 2) + Math.pow(dataY - checkY, 2)
                        );
                        
                        if (distance < (isThrottle ? 8 : 20)) { // Â¢ûÂä†ThrottleÁöÑÊ™¢Ê∏¨ÁØÑÂúç
                            if (isThrottle) {
                                // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÂÄãÈªûÔºåÂè™ËÉΩË™øXÂÄºÔºåYÂõ∫ÂÆöÁÇ∫0
                                if (index === 0) {
                                    isDragging = true;
                                    dragInfo = { level, index, isThrottle, firstPointOnly: true };
                                }
                                // Â¶ÇÊûúÊòØÊúÄÂæå‰∏ÄÂÄãÈªûÔºåÂè™ËÉΩË™øXÂÄºÔºåYÂõ∫ÂÆöÁÇ∫100
                                else if (index === curves[level].length - 1) {
                                    isDragging = true;
                                    dragInfo = { level, index, isThrottle, lastPointOnly: true };
                                }
                                // ÂÖ∂‰ªñÈªûÂèØ‰ª•Ëá™Áî±Ë™øÊï¥
                                else {
                                    isDragging = true;
                                    dragInfo = { level, index, isThrottle, firstPointOnly: false, lastPointOnly: false };
                                }
                            } else {
                                isDragging = true;
                                dragInfo = { level, index, isThrottle, firstPointOnly: false, lastPointOnly: false };
                            }
                            chart.canvas.style.cursor = 'grabbing';
                        }
                    });
                });
            });
            
            chart.canvas.addEventListener('mousemove', (e) => {
                if (isDragging && dragInfo && dragInfo.isThrottle === isThrottle) {
                    const points = Chart.helpers.getRelativePosition(e, chart);
                    const dataX = chart.scales.x.getValueForPixel(points.x);
                    const dataY = chart.scales.y.getValueForPixel(points.y);
                    
                    // Ê†πÊìöÊ®°ÂºèË®≠ÂÆö‰∏çÂêåÁöÑÊãñÊãΩÁØÑÂúç
                    let clampedX, clampedY;
                    if (isThrottle) {
                        // Âü∫Êú¨ÁØÑÂúçÈôêÂà∂
                        clampedX = Math.max(5, Math.min(95, dataX));
                        
                        // Â∞çÊñºYÂÄºÔºåÈúÄË¶ÅËÄÉÊÖÆ‰πòÊï∏ÁöÑÈÄÜÈÅãÁÆó
                        let rawY = Math.max(0, Math.min(110, dataY));
                        if (window.throttleLevelMultipliers && window.throttleLevelMultipliers[dragInfo.level]) {
                            // Â∞áÈ°ØÁ§∫ÁöÑYÂÄºËΩâÊèõÂõûÂéüÂßãYÂÄº
                            rawY = rawY * 100 / window.throttleLevelMultipliers[dragInfo.level];
                        }
                        clampedY = Math.max(0, Math.min(100, rawY));
                        
                        // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÂÄãÈªûÔºåÂõ∫ÂÆöYÂÄºÁÇ∫0
                        if (dragInfo.firstPointOnly) {
                            clampedY = 0;
                        }
                        // Â¶ÇÊûúÊòØÊúÄÂæå‰∏ÄÂÄãÈªûÔºåÂõ∫ÂÆöYÂÄºÁÇ∫100
                        else if (dragInfo.lastPointOnly) {
                            clampedY = 100;
                        }
                        
                        // Ê∑ªÂä†XÂÄºÁöÑÈ†ÜÂ∫èÈôêÂà∂ÔºöÁ¢∫‰øùÂæå‰∏ÄÂÄãÈªûÁöÑXÂÄºÂ§ßÊñºÂâç‰∏ÄÂÄãÈªû
                        const currentCurve = curves[dragInfo.level];
                        const currentIndex = dragInfo.index;
                        
                        // Ë®≠ÂÆöÂâç‰∏ÄÂÄãÈªûÂíåÂæå‰∏ÄÂÄãÈªûÁöÑXÂÄºÈôêÂà∂
                        let minX = 5;  // È†êË®≠ÊúÄÂ∞èÂÄº
                        let maxX = 95; // È†êË®≠ÊúÄÂ§ßÂÄº
                        
                        // Â¶ÇÊûú‰∏çÊòØÁ¨¨‰∏ÄÂÄãÈªûÔºåXÂÄºÂøÖÈ†àÂ§ßÊñºÂâç‰∏ÄÂÄãÈªû
                        if (currentIndex > 0) {
                            minX = Math.max(minX, currentCurve[currentIndex - 1].x + 1);
                        }
                        
                        // Â¶ÇÊûú‰∏çÊòØÊúÄÂæå‰∏ÄÂÄãÈªûÔºåXÂÄºÂøÖÈ†àÂ∞èÊñºÂæå‰∏ÄÂÄãÈªû
                        if (currentIndex < currentCurve.length - 1) {
                            maxX = Math.min(maxX, currentCurve[currentIndex + 1].x - 1);
                        }
                        
                        // ÊáâÁî®È†ÜÂ∫èÈôêÂà∂
                        clampedX = Math.max(minX, Math.min(maxX, clampedX));
                        
                    } else {
                        clampedX = Math.max(10, Math.min(400, dataX));
                        clampedY = Math.max(0, Math.min(800, dataY));
                    }
                    
                    // Êõ¥Êñ∞ÈªûÁöÑ‰ΩçÁΩÆÔºà‰ΩøÁî®ÂéüÂßãÂ∫ßÊ®ôÁ≥ªÁµ±Ôºâ
                    curves[dragInfo.level][dragInfo.index].x = clampedX;
                    curves[dragInfo.level][dragInfo.index].y = clampedY;
                    
                    if (isThrottle) {
                        updateThrottleChart();
                    } else {
                        updatePedalChart();
                    }
                } else {
                    // Ê™¢Êü•ÊªëÈº†ÊòØÂê¶Êá∏ÂÅúÂú®ÊéßÂà∂Èªû‰∏ä
                    const points = Chart.helpers.getRelativePosition(e, chart);
                    const dataX = chart.scales.x.getValueForPixel(points.x);
                    const dataY = chart.scales.y.getValueForPixel(points.y);
                    
                    let isOverPoint = false;
                    Object.keys(curves).forEach(level => {
                        curves[level].forEach((point, index) => {
                            let checkX = point.x;
                            let checkY = point.y;
                            
                            // Â¶ÇÊûúÊòØThrottleÔºåÈúÄË¶ÅËÄÉÊÖÆ‰πòÊï∏Â∞çYÂÄºÁöÑÂΩ±Èüø
                            if (isThrottle && window.throttleLevelMultipliers) {
                                checkY = point.y * window.throttleLevelMultipliers[level] / 100;
                            }
                            
                            const distance = Math.sqrt(
                                Math.pow(dataX - checkX, 2) + Math.pow(dataY - checkY, 2)
                            );
                            if (distance < (isThrottle ? 8 : 20)) {
                                isOverPoint = true;
                            }
                        });
                    });
                    
                    chart.canvas.style.cursor = isOverPoint ? 'grab' : 'default';
                }
            });
            
            chart.canvas.addEventListener('mouseup', () => {
                isDragging = false;
                dragInfo = null;
                chart.canvas.style.cursor = 'default';
            });
        }
        
        // ÁßªÈô§ÊâÄÊúâApplyÂäüËÉΩ
        // function applyPedalToBike() { ... }
        
        // ÂàùÂßãÂåñPedalÂúñË°®
        function initPedalChart() {
            const ctx = document.getElementById('pedalChart').getContext('2d');
            pedalChart = new Chart(ctx, {
                type: 'line',
                data: { datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'nearest'
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Pedal Input Power (W)',
                                font: { size: 14, weight: 'bold' },
                                color: '#333'
                            },
                            min: 0,
                            max: 400,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Motor Output Power (W)',
                                font: { size: 14, weight: 'bold' },
                                color: '#333'
                            },
                            min: 0,
                            max: 800,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Pedal Assist - Pedal Power vs Motor Output',
                            font: { size: 16, weight: 'bold' },
                            color: '#333'
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                filter: function(item) {
                                    return !item.text.includes('_point_');
                                }
                            }
                        },
                        tooltip: {
                            filter: function(tooltipItem) {
                                return !tooltipItem.dataset.label.includes('_point_');
                            }
                        }
                    }
                }
            });
            
            setupDragHandlers(pedalChart, pedalCurves, false);
        }
        
        // ÂàùÂßãÂåñThrottleÂúñË°®
        function initThrottleChart() {
            const ctx = document.getElementById('throttleChart').getContext('2d');
            throttleChart = new Chart(ctx, {
                type: 'line',
                data: { datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'nearest'
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Raw Throttle Position (%)',
                                font: { size: 14, weight: 'bold' },
                                color: '#333'
                            },
                            min: 0,
                            max: 100,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Processed Throttle Position (%)',
                                font: { size: 14, weight: 'bold' },
                                color: '#333'
                            },
                            min: 0,
                            max: 110,  // ÊîπÁÇ∫110%ËÆìÂúñË°®Êõ¥Â•ΩÁúã
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Throttle Progressive Assist',
                            font: { size: 16, weight: 'bold' },
                            color: '#333'
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                filter: function(item) {
                                    return !item.text.includes('_point_');
                                }
                            }
                        },
                        tooltip: {
                            filter: function(tooltipItem) {
                                return !tooltipItem.dataset.label.includes('_point_');
                            }
                        }
                    }
                }
            });
            
            setupDragHandlers(throttleChart, throttleCurves, true);
        }
        
        // È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÂæåÂàùÂßãÂåñ
        window.onload = function() {
            // ÂàùÂßãÂåñthrottleLevelMultipliersÂà∞ÂÖ®Âüü‰ΩúÁî®Âüü - ÂÄíÈÅé‰æÜÔºöLevel1=50%, Level2=75%, Level3=100%
            window.throttleLevelMultipliers = {
                level1: 50,   // Level 1 ‰πòÊï∏ 50%
                level2: 75,   // Level 2 ‰πòÊï∏ 75%
                level3: 100   // Level 3 ‰πòÊï∏ 100%
            };
            
            initPedalChart();
            initThrottleChart();
            
            // È†êË®≠È°ØÁ§∫PedalÈ†ÅÈù¢
            updatePedalChart();
        };
    </script>
</body>
</html>